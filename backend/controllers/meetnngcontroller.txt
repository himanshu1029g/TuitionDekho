const MeetingRequest = require('../models/MeetingRequest');
const User = require('../models/User');
const Teacher = require('../models/Teacher');

// create a meeting request - student sends request to a teacher
const createRequest = async (req, res) => {
  try {
    const studentId = req.user._id;
    const {
      teacherId, // teacher's user id (required)
      teacherProfileId,
      subject,
      class: className,
      mode,
      message
    } = req.body;

    if (!teacherId || !subject || !className || !mode) {
      return res.status(400).json({ success: false, message: 'Missing required fields' });
    }

    // If teacherProfileId not provided, fetch it from the Teacher model using teacherId
    let resolvedTeacherProfileId = teacherProfileId;
    if (!resolvedTeacherProfileId) {
      const teacherProfile = await Teacher.findOne({ userId: teacherId });
      if (!teacherProfile) {
        return res.status(404).json({ success: false, message: 'Teacher profile not found' });
      }
      resolvedTeacherProfileId = teacherProfile._id;
    }

    const mr = new MeetingRequest({
      studentId,
      teacherId,
      teacherProfileId: resolvedTeacherProfileId,
      subject,
      class: className,
      mode,
      message,
      status: 'pending'
    });

    await mr.save();

    // Optionally: populate student brief for response
    await mr.populate('studentId', 'name email');

    // Optional: create notification document if you have Notification model
    // const Notification = require('../models/Notification');
    // await Notification.create({ userId: teacherId, type: 'new_request', data: { requestId: mr._id }, read: false });

    return res.status(201).json({ success: true, message: 'Request created', request: mr });
  } catch (err) {
    console.error('createRequest error', err);
    return res.status(500).json({ success: false, message: 'Server error', error: err.message });
  }
};

// get requests for the logged-in teacher
const getTeacherRequests = async (req, res) => {
  try {
    const teacherUserId = req.user._id;
    const requests = await MeetingRequest.find({ teacherId: teacherUserId })
      .sort({ createdAt: -1 })
      .populate('studentId', 'name email') // include student info
      .populate('teacherProfileId'); // include teacher profile if needed

    return res.json({ success: true, requests });
  } catch (err) {
    console.error('getTeacherRequests error', err);
    return res.status(500).json({ success: false, message: 'Server error', error: err.message });
  }
};

// get requests for the logged-in student
const getStudentRequests = async (req, res) => {
  try {
    const studentUserId = req.user._id;
    const requests = await MeetingRequest.find({ studentId: studentUserId })
      .sort({ createdAt: -1 })
      .populate('teacherId', 'name email')
      .populate('teacherProfileId');

    return res.json({ success: true, requests });
  } catch (err) {
    console.error('getStudentRequests error', err);
    return res.status(500).json({ success: false, message: 'Server error', error: err.message });
  }
};

// delete request (student only, owner)
const deleteRequest = async (req, res) => {
  try {
    const studentUserId = req.user._id;
    const reqId = req.params.id;

    const removed = await MeetingRequest.findOneAndDelete({ _id: reqId, studentId: studentUserId });
    if (!removed) {
      return res.status(404).json({ success: false, message: 'Request not found or unauthorized' });
    }

    return res.json({ success: true, message: 'Request deleted' });
  } catch (err) {
    console.error('deleteRequest error', err);
    return res.status(500).json({ success: false, message: 'Server error', error: err.message });
  }
};

// by me for jitsi
const { v4: uuidv4 } = require('uuid');

exports.createMeeting = async (req, res) => {
  try {
    const meetingId = uuidv4();
    const meetingUrl = `https://meet.jit.si/${meetingId}`;

    return res.json({
      success: true,
      meetingId,
      meetingUrl
    });
  } catch (err) {
    console.error("Meeting create error:", err);
    res.status(500).json({ success: false, msg: "Server error" });
  }
};


module.exports = {
  createRequest,
  getTeacherRequests,
  getStudentRequests,
  deleteRequest
};
